<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Password Modal Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #1557b0;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .hidden {
            display: none !important;
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .modal-header h3 {
            margin: 0 0 20px 0;
            color: #1a73e8;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-input-wrapper input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .password-toggle {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }
        .error-message {
            color: #d93025;
            font-size: 12px;
            margin-top: 4px;
        }
        .attempt-counter {
            margin-top: 8px;
            padding: 8px 12px;
            background: #fef7e0;
            border: 1px solid #f9ab00;
            border-radius: 4px;
            color: #b06000;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .primary-btn {
            background: #1a73e8;
            color: white;
        }
        .secondary-btn {
            background: #f8f9fa;
            color: #3c4043;
            border: 1px solid #dadce0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Master Password Modal Test</h1>
        <p>This page tests the enhanced master password modal functionality with different contexts and attempt tracking.</p>
        
        <div class="test-section">
            <h3>Test Different Contexts</h3>
            <button class="test-button" onclick="testContext('password_reveal')">Test Password Reveal</button>
            <button class="test-button" onclick="testContext('edit')">Test Edit Context</button>
            <button class="test-button" onclick="testContext('copy')">Test Copy Context</button>
            <button class="test-button" onclick="testContext('delete')">Test Delete Context</button>
        </div>

        <div class="test-section">
            <h3>Test Attempt Tracking</h3>
            <button class="test-button" onclick="testFailedAttempt()">Simulate Failed Attempt</button>
            <button class="test-button" onclick="resetAttempts()">Reset Attempts</button>
            <button class="test-button" onclick="showAttemptStatus()">Show Attempt Status</button>
        </div>

        <div id="status-container"></div>
    </div>

    <!-- Master Password Modal -->
    <div id="master-password-modal" class="modal hidden" role="dialog" aria-labelledby="master-password-modal-title" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="master-password-modal-title">Master Password Required</h3>
            </div>
            
            <div class="master-password-content">
                <p id="master-password-message">Please enter your master password to continue:</p>
                
                <div class="input-group">
                    <label for="modal-master-password">Master Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="modal-master-password" placeholder="Enter your master password" autocomplete="current-password">
                        <button type="button" id="toggle-modal-master-password" class="password-toggle" aria-label="Toggle password visibility">
                            <span class="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <div id="modal-master-password-error" class="error-message hidden"></div>
                    <div id="master-password-attempts" class="attempt-counter hidden"></div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="cancel-master-password" class="secondary-btn">Cancel</button>
                <button id="continue-master-password" class="primary-btn">
                    <span>Continue</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Mock PopupController for testing
        class TestPopupController {
            constructor() {
                this.masterPasswordAttempts = 0;
                this.masterPasswordLockoutUntil = null;
                this.masterPasswordContext = null;
                this.masterPasswordResolve = null;
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('cancel-master-password')?.addEventListener('click', () => this.hideMasterPasswordModal());
                document.getElementById('continue-master-password')?.addEventListener('click', () => this.confirmMasterPassword());
                document.getElementById('toggle-modal-master-password')?.addEventListener('click', () => this.togglePasswordVisibility());
            }

            showMasterPasswordModal(message, context = 'general') {
                // Check if currently locked out
                if (this.isLockedOut()) {
                    const remainingTime = Math.ceil((this.masterPasswordLockoutUntil - Date.now()) / 1000);
                    this.showStatus(`Too many failed attempts. Try again in ${remainingTime} seconds.`, 'error');
                    return Promise.resolve(null);
                }

                return new Promise((resolve) => {
                    this.masterPasswordResolve = resolve;
                    this.masterPasswordContext = context;

                    // Update modal title based on context
                    const modalTitle = document.getElementById('master-password-modal-title');
                    if (modalTitle) {
                        switch (context) {
                            case 'password_reveal':
                                modalTitle.textContent = 'Verify Master Password - View Password';
                                break;
                            case 'edit':
                                modalTitle.textContent = 'Verify Master Password - Edit Credential';
                                break;
                            case 'copy':
                                modalTitle.textContent = 'Verify Master Password - Copy Password';
                                break;
                            case 'delete':
                                modalTitle.textContent = 'Verify Master Password - Delete Credential';
                                break;
                            default:
                                modalTitle.textContent = 'Master Password Required';
                        }
                    }

                    const messageElement = document.getElementById('master-password-message');
                    if (messageElement) {
                        messageElement.textContent = message;
                    }

                    const passwordField = document.getElementById('modal-master-password');
                    if (passwordField) {
                        passwordField.value = '';
                    }

                    this.hideFieldError('modal-master-password-error');
                    this.updateAttemptDisplay();

                    const modal = document.getElementById('master-password-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                    }

                    // Focus the password field
                    setTimeout(() => {
                        if (passwordField) {
                            passwordField.focus();
                        }
                    }, 100);
                });
            }

            hideMasterPasswordModal() {
                const modal = document.getElementById('master-password-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }

                const passwordField = document.getElementById('modal-master-password');
                if (passwordField) {
                    passwordField.value = '';
                }

                this.masterPasswordContext = null;

                if (this.masterPasswordResolve) {
                    this.masterPasswordResolve(null);
                    this.masterPasswordResolve = null;
                }
            }

            async confirmMasterPassword() {
                const passwordField = document.getElementById('modal-master-password');
                if (!passwordField) {
                    this.hideMasterPasswordModal();
                    return;
                }

                const password = passwordField.value;
                if (!password) {
                    this.showFieldError('modal-master-password-error', 'Please enter your master password');
                    return;
                }

                // Show loading state
                const continueBtn = document.getElementById('continue-master-password');
                if (continueBtn) {
                    continueBtn.disabled = true;
                    continueBtn.innerHTML = '<span>Verifying...</span>';
                }

                // Simulate verification (for testing, accept "test123" as correct password)
                setTimeout(() => {
                    if (password === 'test123') {
                        // Reset attempts on successful verification
                        this.masterPasswordAttempts = 0;
                        this.masterPasswordLockoutUntil = null;
                        
                        if (this.masterPasswordResolve) {
                            this.masterPasswordResolve(password);
                            this.masterPasswordResolve = null;
                        }

                        // Hide modal
                        const modal = document.getElementById('master-password-modal');
                        if (modal) {
                            modal.classList.add('hidden');
                        }
                        if (passwordField) {
                            passwordField.value = '';
                        }

                        this.showStatus(`Successfully verified password for context: ${this.masterPasswordContext}`, 'success');
                    } else {
                        // Handle failed verification
                        this.handleFailedVerification();
                    }

                    // Restore button state
                    if (continueBtn) {
                        continueBtn.disabled = false;
                        continueBtn.innerHTML = '<span>Continue</span>';
                    }
                }, 1000);
            }

            handleFailedVerification() {
                this.masterPasswordAttempts++;
                
                if (this.masterPasswordAttempts >= 3) {
                    // Lock out for 5 minutes after 3 failed attempts
                    this.masterPasswordLockoutUntil = Date.now() + (5 * 60 * 1000);
                    this.showFieldError('modal-master-password-error', 'Too many failed attempts. Locked out for 5 minutes.');
                    
                    // Hide modal after lockout
                    setTimeout(() => {
                        this.hideMasterPasswordModal();
                    }, 2000);
                } else {
                    const remainingAttempts = 3 - this.masterPasswordAttempts;
                    this.showFieldError('modal-master-password-error', 
                        `Incorrect password. ${remainingAttempts} attempt${remainingAttempts !== 1 ? 's' : ''} remaining.`);
                }

                // Clear password field
                const passwordField = document.getElementById('modal-master-password');
                if (passwordField) {
                    passwordField.value = '';
                    passwordField.focus();
                }

                this.updateAttemptDisplay();
            }

            isLockedOut() {
                return !!(this.masterPasswordLockoutUntil && Date.now() < this.masterPasswordLockoutUntil);
            }

            updateAttemptDisplay() {
                const attemptDisplay = document.getElementById('master-password-attempts');
                if (!attemptDisplay) return;

                if (this.masterPasswordAttempts > 0) {
                    const remainingAttempts = 3 - this.masterPasswordAttempts;
                    attemptDisplay.textContent = `${remainingAttempts} attempt${remainingAttempts !== 1 ? 's' : ''} remaining`;
                    attemptDisplay.classList.remove('hidden');
                } else {
                    attemptDisplay.classList.add('hidden');
                }
            }

            showFieldError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.classList.remove('hidden');
                }
            }

            hideFieldError(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.add('hidden');
                }
            }

            togglePasswordVisibility() {
                const passwordField = document.getElementById('modal-master-password');
                const toggleBtn = document.getElementById('toggle-modal-master-password');
                
                if (passwordField && toggleBtn) {
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        toggleBtn.innerHTML = '<span class="eye-icon">üôà</span>';
                    } else {
                        passwordField.type = 'password';
                        toggleBtn.innerHTML = '<span class="eye-icon">üëÅÔ∏è</span>';
                    }
                }
            }

            showStatus(message, type = 'info') {
                const container = document.getElementById('status-container');
                const statusDiv = document.createElement('div');
                statusDiv.className = `status ${type}`;
                statusDiv.textContent = message;
                
                container.appendChild(statusDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                }, 5000);
            }
        }

        // Initialize test controller
        const testController = new TestPopupController();

        // Test functions
        async function testContext(context) {
            const messages = {
                'password_reveal': 'Please enter your master password to view this password:',
                'edit': 'Please enter your master password to edit this credential:',
                'copy': 'Please enter your master password to copy this password:',
                'delete': 'Please enter your master password to delete this credential:'
            };

            try {
                const result = await testController.showMasterPasswordModal(messages[context], context);
                if (result) {
                    testController.showStatus(`Context test successful: ${context}`, 'success');
                } else {
                    testController.showStatus(`Context test cancelled: ${context}`, 'info');
                }
            } catch (error) {
                testController.showStatus(`Context test error: ${error.message}`, 'error');
            }
        }

        function testFailedAttempt() {
            testController.handleFailedVerification();
            testController.showStatus(`Failed attempt simulated. Attempts: ${testController.masterPasswordAttempts}`, 'info');
        }

        function resetAttempts() {
            testController.masterPasswordAttempts = 0;
            testController.masterPasswordLockoutUntil = null;
            testController.updateAttemptDisplay();
            testController.showStatus('Attempts reset successfully', 'success');
        }

        function showAttemptStatus() {
            const isLocked = testController.isLockedOut();
            const attempts = testController.masterPasswordAttempts;
            const message = isLocked 
                ? `Currently locked out. Attempts: ${attempts}`
                : `Not locked out. Failed attempts: ${attempts}`;
            testController.showStatus(message, isLocked ? 'error' : 'info');
        }

        // Show initial instructions
        testController.showStatus('Test page loaded. Use "test123" as the correct password for testing.', 'info');
    </script>
</body>
</html>